# StockPilot 프로젝트 아키텍처 및 데이터 흐름

## 1. 아키텍처 개요
StockPilot은 Next.js 기반의 웹 애플리케이션으로, **사용자 경험(UX)**을 최적화하기 위한 **Client-Side Batching**과 **외부 API 안정성**을 보장하기 위한 **Server-Side Queue & Rate Limiting** 아키텍처를 채택하고 있습니다.

핵심 데이터 흐름은 **User Input → Client Services → API Queue → Server API → External Data Services**의 파이프라인을 따릅니다.

## 2. 전체 시스템 구조도 (System Flowchart)

아래 다이어그램은 애플리케이션의 엔트리 포인트(`page.tsx`)부터 데이터 저장 및 외부 API 호출까지의 전체 흐름을 시각화한 것입니다.

```mermaid
flowchart TD
    %% 노드 스타일 정의
    classDef normal fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#000;
    classDef db fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000;
    classDef ext fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#000;
    classDef warning fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,stroke-dasharray: 5 5,color:#000;
    classDef mock fill:#ffebee,stroke:#c62828,stroke-width:2px,stroke-dasharray: 5 5,color:#c62828;

    User([👤 User Action]) --> Page[🖥️ Page: src/app/page.tsx]

    subgraph Client [Client Side Layer]
        Page --> Auth[🔐 AuthProvider]
        Page -- "1. Load Portfolios" --> PortSvc[💼 PortfolioService<br/>(Firebase/Local)]
        Page -- "2. Fetch Prices (Hybrid)" --> ApiQueue[⚡ ApiQueue<br/>(Client Batching)]
    end

    subgraph Server [Backend / API Layer]
        ApiQueue -- "/api/kis/prices" --> ApiRoute[🌐 API Route]
        ApiRoute --> ServerKis[🛡️ ServerKisService<br/>(Auth & Config)]
        ServerKis --> KisQueue[🚦 KisRequestQueue<br/>(Server Batching & Rate Limit)]
        
        %% 리포트 생성 흐름
        Page -- "Generate Report" --> ReportGen[📊 ReportGenerator]
        ReportGen --> RealPrice[📈 PriceService]
        
        %% 미연동 구간 표시
        ReportGen --> FinSvc[⚠️ FinancialService<br/>(Mock Data Only)]
        ReportGen --> AnalystSvc[⚠️ AnalystService<br/>(Mock Data Only)]
        
        %% 구현되었으나 연결되지 않은 모듈
        FinSvc -.-> |"(TODO: Connect)"| DartSvc[🛠️ DartService<br/>(Implemented but Unused)]
        AnalystSvc -.-> |"(TODO: Connect)"| NaverCrw[🛠️ NaverCrawler<br/>(Implemented but Unused)]
    end

    subgraph Data [Data & Infrastructure]
        PortSvc -- CRUD --> Firestore[(🔥 Firestore / LocalStorage)]
        KisQueue -- "Real API Call" --> KIS_API[☁️ KIS Investment API]
        
        %% 외부 연결 (현재 끊김)
        DartSvc -.-> DART_API[☁️ DART API]
        NaverCrw -.-> NAVER_WEB[☁️ Naver Finance]
    end

    %% 스타일 적용
    class User,Page,Auth,PortSvc,ApiQueue,ApiRoute,ServerKis,KisQueue,RealPrice,ReportGen normal;
    class Firestore db;
    class KIS_API,DART_API,NAVER_WEB ext;
    class DartSvc,NaverCrw warning;
    class FinSvc,AnalystSvc mock;
```

---

## 3. 계층별 모듈 상세 분석

### 3.1 Frontend Layer (Client)
사용자와 직접 상호작용하며 데이터를 요청하고 표시하는 계층입니다.

- **`page.tsx` (Entry Point)**:
    - 애플리케이션의 메인 대시보드입니다.
    - 사용자 인증 상태를 확인(`AuthProvider`)하고 포트폴리오 데이터를 로드합니다.
    - 성능 최적화를 위해 시세 데이터는 별도의 비동기 흐름(`ApiQueue`)을 통해 가져옵니다.

- **`PortfolioService`**:
    - **역할**: 포트폴리오 및 보유 종목의 CRUD(생성, 조회, 수정, 삭제)를 담당합니다.
    - **특징**: `firebase.json` 설정 및 환경 변수에 따라 **Firestore(Cloud)** 또는 **LocalStorage(Browser)** 중 저장소를 자동으로 선택하여 데이터 지속성을 관리합니다.

- **`ApiQueue` (Singleton)**:
    - **역할**: 클라이언트에서 발생하는 산발적인 시세 조회 요청을 제어합니다.
    - **작동 방식**: 
        1. 요청이 들어오면 즉시 실행하지 않고 100ms 동안 대기(Buffering)합니다.
        2. 대기 중인 여러 종목의 요청을 하나로 묶어(Batching) 서버 API(`/api/kis/prices`)로 전송합니다.
        3. 이를 통해 네트워크 요청 횟수를 줄이고 브라우저 성능을 최적화합니다.

### 3.2 Backend Layer (Server API & Services)
클라이언트의 요청을 처리하고 외부 금융 API와 통신하는 계층입니다.

- **`/api/kis/prices` (API Route)**:
    - Next.js의 서버 사이드 API 엔드포인트입니다.
    - 클라이언트 `ApiQueue`로부터 받은 배치 요청을 검증하고 `ServerKisService`로 전달합니다.

- **`ServerKisService`**:
    - **역할**: 한국투자증권(KIS) API와의 통신을 전담합니다.
    - **보안**: API Key, Secret과 같은 민감한 정보를 서버 측에서만 관리합니다.
    - **기능**: Access Token 발급 및 자동 갱신(만료 5분 전) 로직을 포함합니다.

- **`KisRequestQueue`**:
    - **역할**: KIS API의 엄격한 **Rate Limit(초당 거래 제한)**을 준수하기 위한 안전장치입니다.
    - **작동 방식**:
        1. 서버로 들어온 모든 가격 조회 요청을 중앙 큐에 등록합니다.
        2. 설정된 딜레이에 맞춰 순차적으로 API를 호출하여 초당 제한을 넘지 않도록 제어합니다.
        3. **캐싱(Caching)**: 짧은 시간 내 동일 종목 요청 시 메모리 캐시를 반환하여 불필요한 API 호출을 방지합니다.

- **`ReportGenerator`**:
    - **역할**: 특정 종목에 대한 종합 투자 분석 리포트를 생성합니다.
    - **구성**: 가격, 재무, 애널리스트 데이터 등 다양한 소스의 정보를 취합하여 `Summary`, `Risk`, `Exit Timing` 분석 결과로 가공합니다.

### 3.3 Data Integration Layer (Under Construction)
외부 데이터 소스(DART, Naver Finance 등)와 연동되는 계층입니다. 현재 일부 기능은 구현되어 있으나 연결이 완료되지 않은 상태입니다.

- **`FinancialService` ⚠️**:
    - **현재 상태**: Mock Data (임의의 가짜 데이터)를 반환하도록 하드코딩되어 있습니다.
    - **구현 목표**: 구현된 `DartService`를 내부에서 호출하여 실제 기업의 재무제표 및 밸류에이션 지표를 가져오도록 연결해야 합니다.
    - **관련 파일**: `financial-service.ts`, `dart-service.ts`(Unused)

- **`AnalystService` ⚠️**:
    - **현재 상태**: Mock Data를 반환 중입니다.
    - **구현 목표**: 구현된 `NaverCrawler`를 사용하여 실제 증권사 리포트, 투자의견, 목표가 컨센서스 데이터를 수집하도록 연결해야 합니다.
    - **관련 파일**: `analyst-service.ts`, `naver-crawler.ts`(Unused)

---

## 4. 구현 현황 요약 및 향후 과제

| 모듈 | 상태 | 설명 | 과제 (TODO) |
|:---:|:---:|:---|:---|
| **Auth** | ✅ 완료 | Firebase Auth 기반 로그인/세션 관리 | - |
| **Portfolio** | ✅ 완료 | Firestore/LocalStorage 하이브리드 저장소 | - |
| **Real-time Price** | ✅ 완료 | Client Batching + Server Queuing + KIS API 연동 | - |
| **Report Engine** | ⚠️ 부분 완료 | 리포트 생성 로직 구현 완료, 데이터 소스는 Mock | 실제 데이터 서비스 연결 필요 |
| **Finance Data** | 🛑 미연동 | `DartService` 구현 완료, `FinancialService` 미연결 | `FinancialService` 내부에서 `DartService` 호출 로직 추가 |
| **Analyst Data** | 🛑 미연동 | `NaverCrawler` 구현 완료, `AnalystService` 미연결 | `AnalystService` 내부에서 `NaverCrawler` 호출 로직 추가 |

## 5. 결론
현재 프로젝트는 **안정적인 시세 조회 인프라**와 **사용자 데이터 관리** 체계가 잘 잡혀 있습니다. 다음 단계로는 `ReportGenerator`가 생성하는 분석 보고서의 신뢰도를 높이기 위해, 현재 끊겨 있는 **DART 및 Naver Finance 크롤러 모듈을 실제 서비스 로직과 연결**하는 작업이 최우선 과제입니다.
